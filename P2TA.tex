\documentclass[a4paper,10pt]{article}
\usepackage[utf8]{inputenc}
\usepackage{hyperref}
\usepackage[
    type={CC},
    modifier={by-sa},
    version={4.0},
]{doclicense}

%opening
\title{Pay-to-TagAddress (P2TA): Tagging blockchain transactions for efficient queryability}
\author{Hans Robeers hrobeers@... twitter.com/hrobeers}

\begin{document}

\maketitle

\begin{abstract}
Multiple applications are using existing blockchains as a communication network.
Most of these implementations are scanning to blockchain for transactions matching their own format.
However, this requires a full blockchain node and processing a large blockchain to find application specific transactions can become expensive to execute.
This paper proposes a tagging mechanism, Pay-to-TagAddress (P2TA), that allows efficient lookup of application specific transactions based on the addition of transaction outputs to deterministic tagged addresses. P2TA also allows thin clients to find application specific messages using standard functions exposed by the widely available blockchain explorers.
\end{abstract}

\doclicenseThis

\section{Introduction}
Blockchains, as first introduced by the Bitcoin~\cite{Nak08} network, are used increasingly by third-party applications.
Examples of third-party usage includes Colored Coins~\cite{Ros12}, PeerMessage~\cite{Emeth}, PSA~\cite{Pchem} and multiple others.
These applications typically publish there own specific messages in the form of OP\_RETURN transaction outputs on a third-party blockchain.

Scanning an entire blockchain for messages of a specific form becomes increasingly expensive while the blockchain grows.
Applications like PeerMessage~\cite{Emeth} only rely on real-time transactions being relayed by the network and therefore do not suffer from blockchain growth.
However, applications like PSA~\cite{Pchem} need know an entire history of asset specific transactions to be able to validate asset ownership.
Therefore these type of applications would greatly benefit from a system that allows efficient querying of transactions holding a specific tag.

Blockchain growth also increases disk and memory usage of the full nodes needed to parse the blockchain for application specific messages. For lightweight applications, downloading the entire blockchain might become unfeasable. A query mechanism to find these messages using standard lookup functions, would allow these third-party applictions to be implemented as thin clients interfacing with standard blockchain explorers like blockr.io \cite{Blockr}.

\section{Blockchain queryability}
Blockchain clients are designed to efficiently query for transactions, blocks and addresses by their ids.
Therefore the client can be approached as if it's storing the blockchain indexed on transactions, blocks and addresses.
Querying for non-indexed data on the blockchain can be considered inefficient and to be avoided and might even be unfeasable using a thin client.
For efficient queryability of application specific entities on the blockchain, a tagging mechanism based on the indexed propeties can be used.

\section{Deterministic tagged address}
\label{sec:taggedaddress}
Blockchain addresses are typically created by hashing the public key of a public/private keypair.
To generate secure addresses it is recommended to use a strong random number as a private key.
However, as long as little or no funds are transferred to an address, there is no need for the address to be secure to teft.
Therefore private keys obtained by hashing a publicly known string can generate what we call a deterministic tagged address.

As an example, the command below demonstrates how a tagged address for tag ``my tag'' on the bitcoin network can be created using bitcoin-tool~\cite{Matja}, which is usable for multiple blockchain networks.
\begin{verbatim}
$ bitcoin-tool --input-file <(echo "my tag" | openssl sha256 -binary) \
               --input-type private-key \
               --input-format raw \
               --network bitcoin \
               --output-format base58check \
               --output-type address \
               --public-key-compression compressed
194aYsKYk7nF8Lf7Dak4vQaDg85wqPDy1g
\end{verbatim}

\section{Tagging transactions}
To tag a transaction, a Pay-to-PubkeyHash output to a tagged address is added to the transaction's outputs.
For the output to be valid, it's value may need to be non-zero depending on the blockchain used.
Altough this transaction output is indistinguisable from a standard Pay-to-PubkeyHash output, we refer to these outputs as Pay-to-TagAddress or P2TA in short.

If we define the function \verb|address_for_tag(tag)| as the procedure described in section~\ref{sec:taggedaddress}, the following bitcoin command creates a tagged transaction with tag ``my tag''.
\begin{verbatim}
createrawtransaction [{ "txid": txid, "vout": n }]
    {
      address: amount,
      change_address: change_amount,
      address_for_tag(tag): minimum_amount
    }
\end{verbatim}


\section{Querying tagged transactions}
Most blockchain clients can efficiently query addresses and their linked transactions by their id.
Efficiently finding transactions tagged by a known tag is done as follows:
\begin{itemize}
 \item Generate the tagged address as described in section~\ref{sec:taggedaddress}.
 \item Query the generated address.
 \item The tagged transactions are the incoming transactions on this address.
\end{itemize}


\section{Tag salting}
Tags are usually human readable and human generated rather than randomly generated.
There is a high probability for tags not to be unique.
Therefore, applications using P2TA should be able to cope with unrelated transactions coming in on the tagged address, and lower the client's performance.
A reasonable technique to lower the risk on tag collisions, is adding a publicly known salt to the tag.
This salt might be hard coded in the client application or be randomly generated and broadcasted to the public.
It should be noted that ``tag spamming'' can never be avoided, but unintentional collisions can.


\section{Use case: Peercoin Simple Assets (PSA)}
This section proposes a performance improvement to the PSA~\cite{Pchem} paper as a use case.
Contrary to the Peershares~\cite{TODO} project that creates it's own blockchain, the PSA (Peercoin simple assets) paper proposes a way to register, distribute and trade assets on the Peercoin~\cite{TODO} blockchain.
A naive implementation of P2TA could take the form of adding a simple ``PSA'' tag to every PSA specific message, which would allow a thin client to parse only the application specific messages.
However, a slightly more advanced tagging mechanism is proposed in this section.

\subsection{Deck spawning}
The process to register a new asset on the blockchain is reffered to as ``deck spawning''. A deck is spawned by publishing a message that claims ownership over a specific amount of an asset. From that point on, only the spawning address is able to spawn more of the specific asset. Therefore, an efficient lookup mechanism to check if a specific asset already exists without the need to have the fully parsed PSA tree in memory, improves the client's performance considerably. Other than that, a mechanism to list all ``deck spawning'' messages is desirable to allow all clients to discover third-party assets on the blockchain.

Two tags are added to the transaction's outputs \verb|"PSA/deck spawning"+salt_1| and \verb|"PSA/my asset"+salt_2|.
The resulting transaction outputs for deck spawning look as follows:
\begin{small}\begin{verbatim}
OP_RETURN <data>
OP_DUP OP_HASH160 <change_address_hash> OP_EQUALVERIFY OP_CHECKSIG
OP_DUP OP_HASH160 <pk_hash_for_tag('PSA/deck spawning' + salt_1)> OP_EQUALVERIFY OP_CHECKSIG
OP_DUP OP_HASH160 <pk_hash_for_tag('PSA/my asset' + salt_2)> OP_EQUALVERIFY OP_CHECKSIG
\end{verbatim}\end{small}

\subsection{Asset transaction}
Asset transactions can be linked to their deck spawning transaction by walking up the transaction chain until the deck spawing transaction is reached.
However, walking this chain is not trivial in either direction as transactions can have multiple in- and outputs which may not hold asset transactions.
Therefore tagging the transactions using the asset tag \verb|"PSA/my asset"+salt_2| allows walking the chain with fewer transaction lookups.

The resulting transaction outputs for an asset transaction look as follows:
\begin{small}\begin{verbatim}
OP_RETURN <data>
OP_DUP OP_HASH160 <change_address_hash> OP_EQUALVERIFY OP_CHECKSIG
OP_DUP OP_HASH160 <pk_hash_for_tag('PSA/my asset' + salt_2)> OP_EQUALVERIFY OP_CHECKSIG
\end{verbatim}\end{small}

\subsection{Salting}
Note that a different salt is used for both tags.
Using a different salt for the ``PSA/my asset'' tag allows the creation of multiple assets with the same name but with a different tag.

The deck spawning salt can be hard coded in the client application, making sure that all clients can easily query all ``deck spawning'' transactions.

The asset specific salt is randomly generated and can be communicated to assed holders directly through the OP\_RETURN message or could even be brute forced from the deck spawning transaction if the the salt is limited in size.



Advantages:
\begin{itemize}
 \item No need to parse entire blockchain when creating a new node.
 \item Efficient check wether an asset already exists.
 \item Efficient lookup of asset specific messages.
\end{itemize}

Disadvantages:
\begin{itemize}
 \item Increased transaction size resulting in a higher ppc transaction fee.
\end{itemize}

\section{Conclusion}


\begin{thebibliography}{9}

\bibitem{Nak08}
  S. Nakamoto,
  \emph{Bitcoin: A Peer-to-Peer Electronic Cash System},
  \url{https://bitcoin.org/bitcoin.pdf},
  2008.

\bibitem{Ros12}
  M. Rosenfeld,
  \emph{Overview of Colored Coins},
  \url{https://bitcoil.co.il/BitcoinX.pdf},
  2012.

\bibitem{Emeth}
  Emeth,
  \emph{PeerMessage},
  \url{https://github.com/Peerapps/Peerapps/tree/master/peermessage}.

\bibitem{Pchem}
  Peerchemist,
  \emph{PSA â€“ Peercoin simple assets},
  \url{https://mega.nz/#!GIdGwSjC!k9aLkRbXdx8Si0F3skdHy16D2T_GDaO8Evnedo5cYUA},
  2016.

\bibitem{Matja}
  Matja,
  \emph{bitcoin-tool},
  \url{https://github.com/matja/bitcoin-tool}.

\end{thebibliography}

\end{document}
